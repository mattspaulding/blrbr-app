<!DOCTYPE html>
<html>
	<head>
		<title></title>

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no;" />
		<meta charset="utf-8">
		<link rel="stylesheet" type="text/css" href="css/bootstrap.css" />

		<script type="text/javascript" charset="utf-8" src="cordova.js"></script>
		<script type="text/javascript" src="js/jquery.js"></script>

		<script type="text/javascript">
			var deviceready = false;
			var mediaVar = null;
			var recordFileName = "recording.amr";
			var status = null;
			var isIOS = false;

			function onBodyLoad() {
				document.addEventListener("deviceready", onDeviceReady, false);
				deviceready = true;
			}


			$(document).ready(function() {
				$("#stopBtn").hide();
				$("#playBtn").hide();
				$("#blrbBtn").hide();

				//validation to check if device is ready is skipped

				$("#recordBtn").click(function() {
					record();
				});

				$("#playBtn").click(function() {
					play();
				});

				$("#stopBtn").click(function() {
					stop();
				});
				$("#blrbBtn").click(function() {
					uploadVoice();
				});
			});
			// Set audio position
			//
			function setAudioPosition(position) {
				document.getElementById('audio_position').innerHTML = position;
			}

			function record() {
				createMedia(function() {
					status = "recording";
					mediaVar.startRecord();
					$("#recordBtn").hide();
					$("#stopBtn").show();
					$("#playBtn").hide();
					$("#blrbBtn").hide();

					// Stop recording after 6 sec
					var recTime = 0;
					var recInterval = setInterval(function() {
						if (status == 'recording') {
							recTime = recTime + 1;
							setAudioPosition(recTime + " sec");
						}
						if (recTime >= 6 || status != 'recording') {
							clearInterval(recInterval);
							stop();
						}
					}, 1000);
				}, onStatusChange);
			}

			function createMedia(onMediaCreated, mediaStatusCallback) {
				if (mediaVar != null) {
					onMediaCreated();
					return;
				}

				if ( typeof mediaStatusCallback == 'undefined')
					mediaStatusCallback = null;

				if (isIOS) {
					//first create the file
					window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, function(fileSystem) {
						fileSystem.root.getFile(recordFileName, {
							create : true,
							exclusive : false
						}, function(fileEntry) {
							log("File " + recordFileName + " created at " + fileEntry.fullPath);
							mediaVar = new Media(fileEntry.fullPath, function() {
								//alert("Media created successfully");
								uploadVoice();
							}, onError, mediaStatusCallback);
							//of new Media
							onMediaCreated();
						}, onError);
						//of getFile
					}, onError);
					//of requestFileSystem
				} else//it's Android
				{
					mediaVar = new Media(recordFileName, function() {
						//alert("Media created successfully: " + recordFileName);
					}, onError, mediaStatusCallback);
					onMediaCreated();
				}
			}

			function stop() {
				if (mediaVar == null)
					return;

				if (status == 'recording') {
					mediaVar.stopRecord();

					log("Recording stopped");
				} else if (status == 'playing') {
					mediaVar.stop();
					log("Play stopped");
				} else {
					log("Nothing stopped");
				}
				$("#recordBtn").show();
				$("#stopBtn").hide();
				$("#playBtn").show();
				$("#blrbBtn").show();
				status = 'stopped';
			}

			function play() {
				//playAudio("recording.amr");
				var media = new Media('recording.amr', function() {
					//alert( "Media Success" );
				}, function() {
					//alert("Media Failure, reason: " + err);
				});

				media.play();
			}

			function onStatusChange() {
				if (arguments[0] == 4)//play stopped
				{
					$("#recordBtn").show();
					$("#stopBtn").hide();
					$("#playBtn").show();
					$("#blrbBtn").show();
				}
			}

			function onSuccess() {
				//do nothing
			}

			function onError(err) {
				if ( typeof err.message != 'undefined')
					err = err.message;
				//alert("Error : " + err.message);
			}

			function log(message) {
				if (isIOS)
					alert(message);
				else
					console.info(message);
			}

			function onDeviceReady() {

			}

			function uploadVoice() { debugger;
				var imageURI = "mnt/sdcard/recording.amr";
				var options = new FileUploadOptions();
				options.fileKey = "file";
				options.fileName = imageURI.substr(imageURI.lastIndexOf('/') + 1);
				options.mimeType = "audio/amr";
				options.chunkedMode = false;

				var params = new Object();
				params.channel = "myChannel";
				params.text = "text";
				params.username = "blrbr";

				options.params = params;
				var ft = new FileTransfer();
				ft.upload(imageURI, "http://blrbrdev.azurewebsites.net/Blrb/UploadAudio", win, fail, options);
			window.location="index.html";
			}

			function win(r) {
				///alert("Code = " + r.responseCode);
				///alert("Response = " + r.response);
				///alert("Sent = " + r.bytesSent);
			}

			function fail(error) {
				//alert("An error has occurred: Code = " = error.code);
			}

		</script>
	</head>
	<body onload="onBodyLoad()">
		<button class="btn btn-default btn-lg" style="float:right" name="blrbBtn" id="blrbBtn">
				<span class="glyphicon glyphicon-cloud-upload"></span> Blrb
			</button>
			
		
		<div style="text-align: center; padding-top: 200px;">
			<button class="btn btn-default btn-lg" name="recordBtn" id="recordBtn">
				<span class="glyphicon glyphicon-record"></span> Record
			</button>
			<button class="btn btn-default btn-lg" name="stopBtn" id="stopBtn">
				<span class="glyphicon glyphicon-stop"></span> Stop
			</button>
			<button class="btn btn-default btn-lg" name="playBtn" id="playBtn">
				<span class="glyphicon glyphicon-play"></span> Play
			</button>
			<p id="audio_position"></p>
		</div>
	</body>
</html>